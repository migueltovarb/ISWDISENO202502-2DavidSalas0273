<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Vet Care Pro Console</title>
    <style>
        :root {
            color-scheme: light;
            --primary: #2563eb;
            --bg: #f4f6fb;
            --card: #ffffff;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: #0f172a; }
        header { background: var(--primary); color: #fff; padding: 1.5rem 2rem; }
        main { padding: 2rem; max-width: 1200px; margin: 0 auto; }
        section { background: var(--card); border-radius: 16px; padding: 1.5rem; box-shadow: 0 15px 35px rgba(15,23,42,0.08); margin-bottom: 1.5rem; }
        h1, h2, h3 { margin-top: 0; }
        .actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; }
        .action-card { padding: 1rem; border-radius: 12px; border: 1px solid rgba(37,99,235,0.15); background: #f8fbff; }
        .action-card button { margin-top: 0.75rem; width: 100%; }
        button { background: var(--primary); color: #fff; border: none; border-radius: 10px; padding: 0.8rem 1.2rem; cursor: pointer; font-weight: 600; }
        button.secondary { background: #1e293b; }
        button:hover { opacity: 0.92; }
        .tag { background: rgba(37,99,235,0.12); color: var(--primary); padding: 0.2rem 0.5rem; border-radius: 6px; font-size: 0.8rem; }
        .log { background: #0f172a; color: #e2e8f0; padding: 1rem; border-radius: 10px; min-height: 160px; white-space: pre-wrap; overflow-y: auto; }
        .modal {
            position: fixed; inset: 0; backdrop-filter: blur(4px);
            background: rgba(15,23,42,0.45); display: none; align-items: center; justify-content: center; z-index: 10;
        }
        .modal.active { display: flex; animation: fadeIn 0.2s ease-out; }
        .modal-card {
            background: #fff; border-radius: 16px; width: min(520px, 90vw); max-height: 90vh;
            overflow-y: auto; padding: 1.5rem; box-shadow: 0 25px 65px rgba(15,23,42,0.25);
        }
        .modal-card h3 { margin-top: 0; }
        .modal-card form { display: grid; gap: 0.75rem; }
        input, textarea, select {
            padding: 0.65rem; border-radius: 10px; border: 1px solid #cbd5f5; font-size: 0.95rem;
        }
        textarea { resize: vertical; min-height: 90px; }
        .modal-close { background: #e2e8f0; color: #0f172a; margin-right: 0.5rem; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.97);} to { opacity: 1; transform: scale(1);} }
    </style>
</head>
<body>
<header>
    <h1>Vet Care Pro</h1>
    <p>Panel operativo · Sesión de <strong th:text="${username}">admin</strong></p>
</header>
<main>
    <section>
        <h2>Panel general</h2>
        <p>Selecciona cualquier bloque para abrir su ventana y ejecutar las acciones del dominio veterinario.</p>
        <div style="display:flex; gap:0.75rem; flex-wrap:wrap;">
            <a class="tag" href="/swagger-ui/index.html">Swagger UI</a>
            <a class="tag" href="/actuator/health">Actuator health</a>
        </div>
    </section>

    <section>
        <h3>Acciones disponibles</h3>
        <div class="actions">
            <div class="action-card">
                <h4>Propietarios</h4>
                <p>Alta rápida de dueños y contacto.</p>
                <button onclick="openModal('owner')">Nuevo propietario</button>
            </div>
            <div class="action-card">
                <h4>Veterinarios</h4>
                <p>Registra profesionales con licencia.</p>
                <button onclick="openModal('vet')">Nuevo veterinario</button>
            </div>
            <div class="action-card">
                <h4>Mascotas</h4>
                <p>Vincula mascotas a sus dueños.</p>
                <button onclick="openModal('pet')">Nueva mascota</button>
            </div>
            <div class="action-card">
                <h4>Dueño + Mascota</h4>
                <p>Alta combinada para agilizar registros.</p>
                <button onclick="openModal('ownerPet')">Registrar ambos</button>
            </div>
            <div class="action-card">
                <h4>Citas</h4>
                <p>Agenda consultas o vacunaciones.</p>
                <button onclick="openModal('appointment')">Programar cita</button>
            </div>
            <div class="action-card">
                <h4>Vacunas & certificados</h4>
                <p>Registra vacunas y descarga certificados.</p>
                <button onclick="openModal('vaccine')">Gestionar vacunas</button>
            </div>
            <div class="action-card">
                <h4>Historial médico</h4>
                <p>Documenta diagnósticos y tratamientos.</p>
                <button onclick="openModal('history')">Registrar visita</button>
            </div>
        </div>
    </section>

    <section>
        <h3>Consultas rápidas</h3>
        <div class="actions" style="grid-template-columns: repeat(auto-fit,minmax(160px,1fr));">
            <button class="secondary" onclick="fetchList('/api/owners')">Propietarios</button>
            <button class="secondary" onclick="fetchList('/api/pets')">Mascotas</button>
            <button class="secondary" onclick="fetchList('/api/veterinarians')">Veterinarios</button>
            <button class="secondary" onclick="fetchList('/api/appointments')">Citas</button>
            <button class="secondary" onclick="fetchList('/api/vaccines')">Vacunas</button>
            <button class="secondary" onclick="fetchList('/api/medical-history?petId=PET_ID')">Historial (cambia PET_ID)</button>
        </div>
        <p style="margin-top:1rem;font-size:0.9rem;">Los endpoints se consumen con la sesión actual. Para Postman/Swagger recuerda el header <code>Authorization: Bearer &lt;token&gt;</code>.</p>
        <div class="log" id="api-log">Esperando acciones...</div>
    </section>
</main>

<!-- Modals -->
<div class="modal" id="modal-owner">
    <div class="modal-card">
        <h3>Nuevo propietario</h3>
        <form data-endpoint="/api/auth/register/owner" data-method="POST">
            <input name="username" placeholder="Username" required>
            <input name="password" placeholder="Password" required type="password">
            <input name="fullName" placeholder="Full name" required>
            <input name="email" placeholder="Email" required type="email">
            <input name="phone" placeholder="Phone" required>
            <input name="address" placeholder="Address">
            <div style="display:flex;justify-content:flex-end;">
                <button type="button" class="modal-close" onclick="closeModal('owner')">Cancelar</button>
                <button>Crear propietario</button>
            </div>
        </form>
    </div>
</div>

<div class="modal" id="modal-vet">
    <div class="modal-card">
        <h3>Nuevo veterinario</h3>
        <form data-endpoint="/api/auth/register/vet" data-method="POST">
            <input name="username" placeholder="Username" required>
            <input name="password" placeholder="Password" required type="password">
            <input name="fullName" placeholder="Full name" required>
            <input name="email" placeholder="Email" required type="email">
            <input name="phone" placeholder="Phone" required>
            <input name="licenseNumber" placeholder="License #" required>
            <input name="specialization" placeholder="Specialization">
            <div style="display:flex;justify-content:flex-end;">
                <button type="button" class="modal-close" onclick="closeModal('vet')">Cancelar</button>
                <button>Crear veterinario</button>
            </div>
        </form>
    </div>
</div>

<div class="modal" id="modal-pet">
    <div class="modal-card">
        <h3>Nueva mascota</h3>
        <form data-endpoint="/api/pets" data-method="POST">
            <input name="ownerId" placeholder="Owner ID" required>
            <input name="name" placeholder="Pet name" required>
            <select name="species" required>
                <option value="">Species</option>
                <option value="DOG">DOG</option>
                <option value="CAT">CAT</option>
                <option value="BIRD">BIRD</option>
                <option value="REPTILE">REPTILE</option>
                <option value="SMALL_MAMMAL">SMALL_MAMMAL</option>
                <option value="OTHER">OTHER</option>
            </select>
            <input name="breed" placeholder="Breed">
            <input name="birthDate" placeholder="Birth date (YYYY-MM-DD)">
            <input name="microchipId" placeholder="Microchip ID">
            <select name="neutered">
                <option value="false">Neutered? No</option>
                <option value="true">Neutered? Yes</option>
            </select>
            <div style="display:flex;justify-content:flex-end;">
                <button type="button" class="modal-close" onclick="closeModal('pet')">Cancelar</button>
                <button>Registrar mascota</button>
            </div>
        </form>
    </div>
</div>

<div class="modal" id="modal-appointment">
    <div class="modal-card">
        <h3>Programar cita</h3>
        <form data-endpoint="/api/appointments" data-method="POST">
            <input name="ownerId" placeholder="Owner ID" required>
            <input name="petId" placeholder="Pet ID" required>
            <input name="veterinarianId" placeholder="Vet ID" required>
            <select name="type" required>
                <option value="">Tipo</option>
                <option value="CONSULTATION">CONSULTATION</option>
                <option value="VACCINATION">VACCINATION</option>
            </select>
            <input name="appointmentDate" placeholder="Date (2025-01-15T10:00)" required>
            <input name="reason" placeholder="Reason">
            <input name="vaccineId" placeholder="Vaccine ID (if vaccination)">
            <textarea name="notes" placeholder="Notes"></textarea>
            <div style="display:flex;justify-content:flex-end;">
                <button type="button" class="modal-close" onclick="closeModal('appointment')">Cancelar</button>
                <button>Crear cita</button>
            </div>
        </form>
    </div>
</div>

<div class="modal" id="modal-vaccine">
    <div class="modal-card">
        <h3>Vacunas & certificados</h3>
        <form data-endpoint="/api/vaccines" data-method="POST">
            <input name="name" placeholder="Vaccine name" required>
            <input name="manufacturer" placeholder="Manufacturer">
            <textarea name="description" placeholder="Description"></textarea>
            <input name="validityDays" placeholder="Validity days" type="number" value="365">
            <input name="reminderWindowDays" placeholder="Reminder days" type="number" value="7">
            <div style="display:flex;justify-content:flex-end;">
                <button type="button" class="modal-close" onclick="closeModal('vaccine')">Cancelar</button>
                <button>Registrar vacuna</button>
            </div>
        </form>
        <hr>
        <div style="display:flex; gap:0.5rem; align-items:center;">
            <input id="certificate-id" placeholder="Certificate ID">
            <button type="button" onclick="downloadCertificate()">Descargar certificado</button>
        </div>
    </div>
</div>

<div class="modal" id="modal-history">
    <div class="modal-card">
        <h3>Historial médico</h3>
        <form data-endpoint="/api/medical-history" data-method="POST">
            <input name="petId" placeholder="Pet ID" required>
            <input name="veterinarianId" placeholder="Vet ID" required>
            <input name="visitDate" placeholder="Visit date (2025-01-01T14:00)" required>
            <textarea name="summary" placeholder="Summary" required></textarea>
            <textarea name="diagnosis" placeholder="Diagnosis"></textarea>
            <textarea name="recommendations" placeholder="Recommendations"></textarea>
            <input name="treatments" placeholder="Treatments (comma separated)">
            <div style="display:flex;justify-content:flex-end;">
                <button type="button" class="modal-close" onclick="closeModal('history')">Cancelar</button>
                <button>Registrar visita</button>
            </div>
        </form>
    </div>
</div>

<div class="modal" id="modal-ownerPet">
    <div class="modal-card">
        <h3>Registrar dueño y mascota</h3>
        <p style="margin-top:-0.5rem;">Se creará primero el propietario y con su ID se asociará la mascota.</p>
        <form data-combined="owner-pet">
            <h4>Datos del propietario</h4>
            <input name="owner.username" placeholder="Username" required>
            <input name="owner.password" placeholder="Password" required type="password">
            <input name="owner.fullName" placeholder="Full name" required>
            <input name="owner.email" placeholder="Email" required type="email">
            <input name="owner.phone" placeholder="Phone" required>
            <input name="owner.address" placeholder="Address">

            <h4>Datos de la mascota</h4>
            <input name="pet.name" placeholder="Pet name" required>
            <select name="pet.species" required>
                <option value="">Species</option>
                <option value="DOG">DOG</option>
                <option value="CAT">CAT</option>
                <option value="BIRD">BIRD</option>
                <option value="REPTILE">REPTILE</option>
                <option value="SMALL_MAMMAL">SMALL_MAMMAL</option>
                <option value="OTHER">OTHER</option>
            </select>
            <input name="pet.breed" placeholder="Breed">
            <input name="pet.birthDate" placeholder="Birth date (YYYY-MM-DD)">
            <input name="pet.microchipId" placeholder="Microchip ID">
            <select name="pet.neutered">
                <option value="false">Neutered? No</option>
                <option value="true">Neutered? Yes</option>
            </select>

            <div style="display:flex;justify-content:flex-end;">
                <button type="button" class="modal-close" onclick="closeModal('ownerPet')">Cancelar</button>
                <button>Registrar ambos</button>
            </div>
        </form>
    </div>
</div>

<script>
    const logEl = document.getElementById('api-log');

    const modals = ["owner","vet","pet","appointment","vaccine","history","ownerPet"];
    function openModal(name) {
        document.getElementById(`modal-${name}`).classList.add('active');
    }
    function closeModal(name) {
        const modal = document.getElementById(`modal-${name}`);
        modal.classList.remove('active');
        modal.querySelector('form').reset();
    }
    modals.forEach(name => {
        document.getElementById(`modal-${name}`).addEventListener('click', e => {
            if (e.target.classList.contains('modal')) closeModal(name);
        });
    });

    function toJSON(form) {
        const data = {};
        new FormData(form).forEach((value, key) => {
            if (value === '') return;
            if (key === 'validityDays' || key === 'reminderWindowDays') {
                data[key] = Number(value);
            } else if (key === 'neutered') {
                data[key] = value === 'true';
            } else if (key === 'treatments') {
                data[key] = value.split(',').map(v => v.trim()).filter(Boolean);
            } else {
                data[key] = value;
            }
        });
        return data;
    }

    function logResponse(title, payload) {
        const time = new Date().toLocaleTimeString();
        logEl.textContent = `[${time}] ${title}\n${JSON.stringify(payload, null, 2)}\n\n${logEl.textContent}`;
    }

    document.querySelectorAll('form[data-endpoint], form[data-combined]').forEach(form => {
        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            if (form.dataset.combined === 'owner-pet') {
                await registerOwnerPet(form);
                return;
            }
            const endpoint = form.dataset.endpoint;
            const method = form.dataset.method || 'POST';
            const payload = toJSON(form);
            try {
                const res = await fetch(endpoint, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json().catch(() => ({}));
                logResponse(`${method} ${endpoint} (${res.status})`, data);
            } catch (error) {
                logResponse(`ERROR ${endpoint}`, { message: error.message });
            }
        });
    });

    async function fetchList(endpoint) {
        try {
            const res = await fetch(endpoint);
            const data = await res.json();
            logResponse(`GET ${endpoint} (${res.status})`, data);
        } catch (error) {
            logResponse(`ERROR ${endpoint}`, { message: error.message });
        }
    }

    async function downloadCertificate() {
        const id = document.getElementById('certificate-id').value;
        if (!id) {
            alert('Ingresa el ID del certificado');
            return;
        }
        const res = await fetch(`/api/certificates/${id}`);
        if (!res.ok) {
            logResponse(`GET /api/certificates/${id}`, { status: res.status, message: await res.text() });
            return;
        }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `certificate-${id}.pdf`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        logResponse('Certificate downloaded', { id });
    }

    async function registerOwnerPet(form) {
        const data = {};
        new FormData(form).forEach((value, key) => data[key] = value);
        const ownerPayload = {
            username: data["owner.username"],
            password: data["owner.password"],
            fullName: data["owner.fullName"],
            email: data["owner.email"],
            phone: data["owner.phone"],
            address: data["owner.address"]
        };
        const petPayload = {
            name: data["pet.name"],
            species: data["pet.species"],
            breed: data["pet.breed"],
            birthDate: data["pet.birthDate"],
            microchipId: data["pet.microchipId"],
            neutered: data["pet.neutered"] === "true"
        };
        try {
            const ownerRes = await fetch("/api/auth/register/owner", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(ownerPayload)
            });
            const ownerData = await ownerRes.json();
            if (!ownerRes.ok) {
                logResponse("Owner creation failed", ownerData);
                return;
            }
            petPayload.ownerId = ownerData.id;
            const petRes = await fetch("/api/pets", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(petPayload)
            });
            const petData = await petRes.json();
            logResponse(`Owner+Pet (${ownerRes.status}/${petRes.status})`, { owner: ownerData, pet: petData });
            closeModal("ownerPet");
        } catch (error) {
            logResponse("Owner+Pet error", { message: error.message });
        }
    }
</script>
</body>
</html>
